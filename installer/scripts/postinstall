#!/bin/bash

# Post-installation script for Resource Monitor
set -e

CURRENT_USER=$(stat -f "%Su" /dev/console)
USER_HOME=$(eval echo ~$CURRENT_USER)

echo "Setting up for user: $CURRENT_USER"

# Copy LaunchAgent to user's LaunchAgents folder
mkdir -p "$USER_HOME/Library/LaunchAgents"
if [ -f "/Library/LaunchAgents/com.fx.resource-monitor.plist" ]; then
    cp "/Library/LaunchAgents/com.fx.resource-monitor.plist" "$USER_HOME/Library/LaunchAgents/"
    chown "$CURRENT_USER" "$USER_HOME/Library/LaunchAgents/com.fx.resource-monitor.plist"

    # Load the LaunchAgent (start backend service)
    sudo -u "$CURRENT_USER" launchctl load "$USER_HOME/Library/LaunchAgents/com.fx.resource-monitor.plist" 2>/dev/null || true
fi

# Add app to Login Items for current user (if app exists)
if [ -d "/Applications/ResourceMonitor.app" ]; then
    sudo -u "$CURRENT_USER" osascript -e 'tell application "System Events" to make login item at end with properties {path:"/Applications/ResourceMonitor.app", hidden:false}' 2>/dev/null || true

    # Start the app now
    sudo -u "$CURRENT_USER" open /Applications/ResourceMonitor.app 2>/dev/null || true
fi

echo "Resource Monitor installed successfully!"
exit 0
