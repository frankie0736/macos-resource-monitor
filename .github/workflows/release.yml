name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: backend/go.sum

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build Backend
        run: |
          cd backend
          go build -o resource-monitor .

      - name: Build Frontend
        run: |
          cd frontend/ResourceMonitor
          xcodebuild -project ResourceMonitor.xcodeproj \
            -scheme ResourceMonitor \
            -configuration Release \
            build \
            SYMROOT=build

      - name: Prepare PKG Payload
        run: |
          mkdir -p installer/payload/Applications
          mkdir -p installer/payload/usr/local/bin
          mkdir -p installer/payload/Library/LaunchAgents
          cp -R frontend/ResourceMonitor/build/Release/ResourceMonitor.app installer/payload/Applications/
          cp backend/resource-monitor installer/payload/usr/local/bin/
          cp com.fx.resource-monitor.plist installer/payload/Library/LaunchAgents/

      - name: Build PKG
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          pkgbuild --root installer/payload \
            --scripts installer/scripts \
            --identifier com.fx.resource-monitor \
            --version ${VERSION} \
            --install-location / \
            --ownership recommended \
            --component-plist installer/component.plist \
            ResourceMonitor-${VERSION}.pkg

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ResourceMonitor-*.pkg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
